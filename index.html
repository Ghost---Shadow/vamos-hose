<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vamos-hose: 13C NMR Predictor</title>
    <script type="importmap">
    {
        "imports": {
            "openchemlib": "https://unpkg.com/openchemlib@9.20.0/dist/openchemlib.js"
        }
    }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        header {
            background: #2d2d30;
            padding: 1rem 2rem;
            border-bottom: 1px solid #3e3e42;
        }
        h1 { font-size: 1.5rem; color: #fff; }
        .subtitle { font-size: 0.9rem; color: #858585; margin-top: 0.25rem; }
        .container { display: flex; flex: 1; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header {
            background: #2d2d30; padding: 0.75rem 1rem;
            border-bottom: 1px solid #3e3e42; font-weight: 600;
            font-size: 0.9rem; color: #ccc;
        }
        .input-panel { border-right: 1px solid #3e3e42; max-width: 400px; }
        .input-content { padding: 1rem; overflow-y: auto; flex: 1; }
        label { display: block; margin-bottom: 0.25rem; color: #9cdcfe; font-size: 0.9rem; }
        input[type="text"] {
            width: 100%; padding: 0.5rem; background: #3c3c3c; color: #d4d4d4;
            border: 1px solid #3e3e42; border-radius: 3px; font-family: 'Consolas', monospace;
            font-size: 1rem;
        }
        input[type="text"]:focus { outline: none; border-color: #007acc; }
        .examples { margin-top: 1rem; }
        .examples h3 { color: #4ec9b0; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .example-btn {
            display: block; width: 100%; text-align: left;
            background: #252526; border: 1px solid #3e3e42; border-radius: 3px;
            color: #ce9178; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem;
            cursor: pointer; font-size: 0.85rem; font-family: 'Consolas', monospace;
        }
        .example-btn:hover { background: #2a2d2e; border-color: #007acc; }
        .example-btn .name { color: #dcdcaa; display: block; font-family: 'Segoe UI', sans-serif; margin-bottom: 0.15rem; }
        .output-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .spectrum-container {
            background: #fff; border: 1px solid #3e3e42; border-radius: 4px;
            padding: 0.5rem; margin-bottom: 1rem;
        }
        .spectrum-container svg { width: 100%; height: auto; display: block; }
        .shift-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .shift-table th {
            text-align: left; padding: 0.5rem; border-bottom: 2px solid #3e3e42;
            color: #4ec9b0; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .shift-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid #3e3e42; }
        .shift-table tr:hover td { background: #2a2d2e; }
        .shift-value { color: #b5cea8; font-family: 'Consolas', monospace; }
        .hose-code { color: #ce9178; font-family: 'Consolas', monospace; font-size: 0.8rem; }
        .spinner-overlay {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 4rem 1rem; gap: 1.5rem;
        }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid #3e3e42; border-top-color: #007acc;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner-text { color: #858585; font-size: 1rem; }
        .molecule-viewer {
            background: #fff; border: 1px solid #3e3e42; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            min-height: 200px; margin-bottom: 1rem;
        }
        .summary {
            background: #252526; border: 1px solid #3e3e42; border-radius: 4px;
            padding: 0.75rem 1rem; margin-bottom: 1rem;
        }
        .summary-row { display: flex; justify-content: space-between; padding: 0.25rem 0; }
        .summary-label { color: #9cdcfe; }
        .summary-value { color: #b5cea8; font-family: 'Consolas', monospace; }
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .input-panel { max-width: none; border-right: none; border-bottom: 1px solid #3e3e42; max-height: 40vh; }
        }
    </style>
</head>
<body>
    <header>
        <h1>vamos-hose</h1>
        <p class="subtitle">Predict 13C NMR chemical shifts from SMILES using HOSE codes and nmrshiftdb2</p>
    </header>
    <div class="container">
        <div class="panel input-panel">
            <div class="panel-header">Input</div>
            <div class="input-content">
                <label for="smiles-input">SMILES</label>
                <input type="text" id="smiles-input" placeholder="Enter SMILES string..." value="CC(=O)Oc1ccccc1C(=O)O">
                <div class="examples">
                    <h3>Examples</h3>
                    <button class="example-btn" data-smiles="CC(=O)Oc1ccccc1C(=O)O"><span class="name">Aspirin</span>CC(=O)Oc1ccccc1C(=O)O</button>
                    <button class="example-btn" data-smiles="CC(C)Cc1ccc(cc1)C(C)C(=O)O"><span class="name">Ibuprofen</span>CC(C)Cc1ccc(cc1)C(C)C(=O)O</button>
                    <button class="example-btn" data-smiles="CC(=O)Nc1ccc(O)cc1"><span class="name">Acetaminophen</span>CC(=O)Nc1ccc(O)cc1</button>
                    <button class="example-btn" data-smiles="CN1CCC23C4C1CC5=C2C(=C(C=C5)O)OC3C(C=C4)O"><span class="name">Morphine</span>CN1CCC23C4C1CC5=C2C(=C(C=C5)O)OC3C(C=C4)O</button>
                    <button class="example-btn" data-smiles="CCC(=O)N(C1CCN(CC1)CCC2=CC=CC=C2)C3=CC=CC=C3"><span class="name">Fentanyl</span>CCC(=O)N(C1CCN(CC1)CCC2=CC=CC=C2)C3=CC=CC=C3</button>
                    <button class="example-btn" data-smiles="CC(C)OC(=O)C(C)(C)Oc1ccc(cc1)C(=O)c2ccc(Cl)cc2"><span class="name">Fenofibrate</span>CC(C)OC(=O)C(C)(C)Oc1ccc(cc1)C(=O)c2ccc(Cl)cc2</button>
                    <button class="example-btn" data-smiles="CC12CCC(=O)C=C1CCC1C2C(O)CC2(C)C(C(=O)CO)CCC12"><span class="name">Cortisone</span>CC12CCC(=O)C=C1CCC1C2C(O)CC2(C)C(C(=O)CO)CCC12</button>
                    <button class="example-btn" data-smiles="CCN(CC)CC(=O)NC1=C(C)C=CC=C1C"><span class="name">Lidocaine</span>CCN(CC)CC(=O)NC1=C(C)C=CC=C1C</button>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">13C NMR Prediction</div>
            <div class="output-content" id="output">
                <div class="summary"><p style="color:#858585; text-align:center;">Enter a SMILES string or click an example to predict 13C NMR shifts</p></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <script type="module">
        import { lookupNmrShifts } from 'https://unpkg.com/vamos-hose@latest/index.js';

        let smilesDrawer;
        function initSmilesDrawer() {
            if (typeof SmilesDrawer !== 'undefined' && !smilesDrawer) {
                smilesDrawer = new SmilesDrawer.SvgDrawer({ width: 400, height: 200, bondThickness: 2 });
            }
        }
        window.addEventListener('load', initSmilesDrawer);

        const input = document.getElementById('smiles-input');
        const output = document.getElementById('output');

        function showSpinner() {
            output.innerHTML = '<div class="spinner-overlay"><div class="spinner"></div><div class="spinner-text">Predicting shifts\u2026</div></div>';
        }

        function drawLorentzianSVG(container, shifts, options = {}) {
            const { range = [0, 220], lineWidth = 0.5 } = options;
            const svgW = 800;
            const svgH = 280;
            const marginTop = 32;
            const marginBottom = 52;
            const marginLeft = 10;
            const marginRight = 10;
            const plotW = svgW - marginLeft - marginRight;
            const plotH = svgH - marginTop - marginBottom;
            const [lo, hi] = range;
            const gamma = lineWidth;

            // Build intensity curve at high resolution
            const numPts = plotW * 2;
            const curve = new Float64Array(numPts);
            for (const s of shifts) {
                for (let i = 0; i < numPts; i++) {
                    const ppm = hi - (i / numPts) * (hi - lo);
                    const diff = ppm - s.shift;
                    curve[i] += (gamma * gamma) / (diff * diff + gamma * gamma);
                }
            }
            const maxI = Math.max(...curve) || 1;

            // Build path data for the curve
            let linePath = '';
            let areaPath = `M${marginLeft},${marginTop + plotH}`;
            for (let i = 0; i < numPts; i++) {
                const x = marginLeft + (i / numPts) * plotW;
                const y = marginTop + plotH * (1 - curve[i] / maxI);
                if (i === 0) { linePath += `M${x.toFixed(1)},${y.toFixed(1)}`; }
                else { linePath += `L${x.toFixed(1)},${y.toFixed(1)}`; }
                areaPath += `L${x.toFixed(1)},${y.toFixed(1)}`;
            }
            areaPath += `L${marginLeft + plotW},${marginTop + plotH}Z`;

            // Build tick marks
            const step = hi - lo <= 50 ? 5 : hi - lo <= 100 ? 10 : 20;
            let ticksSVG = '';
            for (let ppm = Math.ceil(lo / step) * step; ppm <= hi; ppm += step) {
                const x = marginLeft + plotW * (hi - ppm) / (hi - lo);
                const yBase = marginTop + plotH;
                ticksSVG += `<line x1="${x}" y1="${yBase}" x2="${x}" y2="${yBase + 6}" stroke="#333" stroke-width="1"/>`;
                ticksSVG += `<text x="${x}" y="${yBase + 20}" text-anchor="middle" fill="#333" font-family="Consolas, monospace" font-size="12">${ppm}</text>`;
            }

            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgW} ${svgH}" width="${svgW}" height="${svgH}">
                <rect width="${svgW}" height="${svgH}" fill="#fff"/>
                <text x="${marginLeft + 4}" y="20" font-family="Segoe UI, sans-serif" font-size="14" font-weight="bold" fill="#333">Predicted 13C NMR Spectrum</text>
                <path d="${areaPath}" fill="rgba(0,100,200,0.15)"/>
                <path d="${linePath}" fill="none" stroke="#0064c8" stroke-width="1.5"/>
                <line x1="${marginLeft}" y1="${marginTop + plotH}" x2="${marginLeft + plotW}" y2="${marginTop + plotH}" stroke="#333" stroke-width="1"/>
                ${ticksSVG}
                <text x="${svgW / 2}" y="${svgH - 8}" text-anchor="middle" fill="#333" font-family="Segoe UI, sans-serif" font-size="13">Chemical Shift (ppm)</text>
            </svg>`;

            container.innerHTML = svg;
        }

        async function predict(smiles) {
            if (!smiles.trim()) {
                output.innerHTML = '<div class="summary"><p style="color:#858585; text-align:center;">Enter a SMILES string</p></div>';
                return;
            }

            showSpinner();

            try {
                const shifts = await lookupNmrShifts(smiles, { nucleus: '13C' });

                if (!shifts || shifts.length === 0) {
                    output.innerHTML = '<div class="summary" style="border-color:#be1100;"><p style="color:#f48771;">No carbon shifts predicted. Check if the SMILES is valid and contains carbon atoms.</p></div>';
                    return;
                }

                const sorted = [...shifts].sort((a, b) => b.shift - a.shift);
                const minShift = Math.min(...shifts.map(s => s.shift));
                const maxShift = Math.max(...shifts.map(s => s.shift));

                let html = '';

                // Molecule viewer
                html += '<div class="molecule-viewer"><svg id="mol-svg" width="400" height="200"></svg></div>';

                // Summary
                html += '<div class="summary">';
                html += `<div class="summary-row"><span class="summary-label">Carbon atoms</span><span class="summary-value">${shifts.length}</span></div>`;
                html += `<div class="summary-row"><span class="summary-label">Shift range</span><span class="summary-value">${minShift.toFixed(1)} - ${maxShift.toFixed(1)} ppm</span></div>`;
                html += '</div>';

                // Spectrum (SVG)
                html += '<div class="spectrum-container" id="spectrum-container"></div>';

                // Shift table
                html += '<table class="shift-table"><thead><tr><th>#</th><th>Shift (ppm)</th><th>HOSE Code</th></tr></thead><tbody>';
                sorted.forEach((s, i) => {
                    html += `<tr><td>${i + 1}</td><td class="shift-value">${s.shift.toFixed(1)}</td><td class="hose-code">${s.hose || ''}</td></tr>`;
                });
                html += '</tbody></table>';

                output.innerHTML = html;

                // Draw spectrum
                const specContainer = document.getElementById('spectrum-container');
                if (specContainer) drawLorentzianSVG(specContainer, shifts);

                // Draw molecule
                initSmilesDrawer();
                if (smilesDrawer) {
                    setTimeout(() => {
                        try {
                            SmilesDrawer.parse(smiles, tree => {
                                smilesDrawer.draw(tree, 'mol-svg', 'light', false);
                            }, err => {
                                const viewer = document.querySelector('.molecule-viewer');
                                if (viewer) viewer.innerHTML = `<p style="color:#f48771;">Cannot render: ${err}</p>`;
                            });
                        } catch (e) {}
                    }, 10);
                }

                // Spinner replaced by results above
            } catch (err) {
                output.innerHTML = `<div class="summary" style="border-color:#be1100;"><p style="color:#f48771;">Error: ${err.message}</p></div>`;
            }
        }

        // Debounce input
        let timer;
        input.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(() => predict(input.value), 500);
        });

        // Example buttons
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                input.value = btn.dataset.smiles;
                predict(input.value);
            });
        });

        // Initial prediction
        predict(input.value);
    </script>
</body>
</html>
